{"componentChunkName":"component---src-templates-blog-post-js","path":"/JPA 영속성(Persistence) 정리","result":{"data":{"site":{"siteMetadata":{"title":"Gunlog","author":"Gun Kim","siteUrl":"https://gunlog.dev","comment":{"disqusShortName":"","utterances":"JaeYeopHan/gatsby-starter-bee"},"sponsor":{"buyMeACoffeeId":"jbee"}}},"markdownRemark":{"id":"9c715f09-4dbd-5f72-8db6-c024386e1758","excerpt":"JPA를 그동안 사용하면서 잘 알지 못하고 사용해왔는데, JPA에 대해서 제대로 알기 위해서 가장 중요한 개념인 영속성(Persistence)에 대해서 정리해보려고 한다. 영속성 컨텍스트(Persistence Context…","html":"<p>JPA를 그동안 사용하면서 잘 알지 못하고 사용해왔는데, JPA에 대해서 제대로 알기 위해서 가장 중요한 개념인 영속성(Persistence)에 대해서 정리해보려고 한다.</p>\n<h1 id=\"영속성-컨텍스트persistence-context-의미\" style=\"position:relative;\"><a href=\"#%EC%98%81%EC%86%8D%EC%84%B1-%EC%BB%A8%ED%85%8D%EC%8A%A4%ED%8A%B8persistence-context-%EC%9D%98%EB%AF%B8\" aria-label=\"영속성 컨텍스트persistence context 의미 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>영속성 컨텍스트(Persistence Context) 의미</h1>\n<blockquote>\n<p>엔티티가 영구 지속되는 환경.</p>\n</blockquote>\n<p>눈에 보이거나 하는 것은 아니기 때문에 논리적인 개념이라고 표현한다.</p>\n<h2 id=\"국어사전을-뒤져-보았다\" style=\"position:relative;\"><a href=\"#%EA%B5%AD%EC%96%B4%EC%82%AC%EC%A0%84%EC%9D%84-%EB%92%A4%EC%A0%B8-%EB%B3%B4%EC%95%98%EB%8B%A4\" aria-label=\"국어사전을 뒤져 보았다 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>국어사전을 뒤져 보았다.</h2>\n<p>그냥 내가 단어의 뜻이 궁금해서 한번 찾아 보았는데, 말이 되도록 끼워 맞춰보면 <strong>(무언가가) 오래도록 지속되는 환경</strong> 정도로 해석할 수 있을 것 같다.</p>\n<p><img src=\"https://user-images.githubusercontent.com/45007556/97259424-1861ff00-185e-11eb-9606-4f08e10670d5.png\" alt=\"image\">\n<img src=\"https://user-images.githubusercontent.com/45007556/97259448-1ef07680-185e-11eb-8fe5-d680e4fcb6e9.png\" alt=\"image\"></p>\n<h1 id=\"영속성-컨텍스트의-구조\" style=\"position:relative;\"><a href=\"#%EC%98%81%EC%86%8D%EC%84%B1-%EC%BB%A8%ED%85%8D%EC%8A%A4%ED%8A%B8%EC%9D%98-%EA%B5%AC%EC%A1%B0\" aria-label=\"영속성 컨텍스트의 구조 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>영속성 컨텍스트의 구조</h1>\n<blockquote>\n<p><em>1차 캐시 저장소</em>, <em>SQL 저장소</em>로 나뉘어 진다.</p>\n</blockquote>\n<p><img src=\"https://user-images.githubusercontent.com/45007556/97259497-3e879f00-185e-11eb-9fe2-688c9012a85b.png\" alt=\"image\"></p>\n<h2 id=\"1차-캐시-저장소\" style=\"position:relative;\"><a href=\"#1%EC%B0%A8-%EC%BA%90%EC%8B%9C-%EC%A0%80%EC%9E%A5%EC%86%8C\" aria-label=\"1차 캐시 저장소 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><em>1차 캐시 저장소</em></h2>\n<blockquote>\n<p>엔티티를 조회하거나 저장할 경우 해당 엔티티는 1차 캐시에 저장된다.</p>\n</blockquote>\n<p>1차 캐시는 Map형태(Key-Value)로 보관이 되는데 식별자값(Key)을 통해서 엔티티를 조회해서 1차 캐시에 없을 경우 DB 조회 후 생성해서 넣고, 있을 경우 1차 캐시에 엔티티를 반환해준다. 그래서 Map을 통해 같은 엔티티를 반환하기에 a==b같은 동일성을 보장해준다.</p>\n<h3 id=\"1차-캐시의-동작-순서\" style=\"position:relative;\"><a href=\"#1%EC%B0%A8-%EC%BA%90%EC%8B%9C%EC%9D%98-%EB%8F%99%EC%9E%91-%EC%88%9C%EC%84%9C\" aria-label=\"1차 캐시의 동작 순서 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1차 캐시의 동작 순서</h3>\n<ol>\n<li>최초 조회할 때는 1차 캐시에 엔티티가 없다.</li>\n<li>DB에서 엔티티를 조회한다.</li>\n<li>엔티티를 1차 캐시에 보관한다. 이 때 최초 값을 따로 저장해두는 데, 이 값을 <strong>스냅샷</strong>이라고 한다.</li>\n<li>1차 캐시에 보관된 결과를 반환한다.</li>\n<li>이후 같은 식별자를 통해 엔티티를 조회하면 DB 조회없이 1차 캐시에 엔티티를 그대로 반환한다.</li>\n</ol>\n<h2 id=\"sql-저장소\" style=\"position:relative;\"><a href=\"#sql-%EC%A0%80%EC%9E%A5%EC%86%8C\" aria-label=\"sql 저장소 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><em>SQL 저장소</em></h2>\n<p>여러 SQL을 저장했다가 트랜잭션을 commit할 때 한번에 처리한다. 이를 통해 DB 접근 횟수를 최소화하고 성능상 이점을 얻을 수 있다.</p>\n<h1 id=\"엔티티-매니저entity-manager와-엔티티-매니저-공장entity-manager-factory\" style=\"position:relative;\"><a href=\"#%EC%97%94%ED%8B%B0%ED%8B%B0-%EB%A7%A4%EB%8B%88%EC%A0%80entity-manager%EC%99%80-%EC%97%94%ED%8B%B0%ED%8B%B0-%EB%A7%A4%EB%8B%88%EC%A0%80-%EA%B3%B5%EC%9E%A5entity-manager-factory\" aria-label=\"엔티티 매니저entity manager와 엔티티 매니저 공장entity manager factory permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>엔티티 매니저(Entity Manager)와 엔티티 매니저 공장(Entity Manager Factory)</h1>\n<blockquote>\n<p>영속성 컨텍스트를 위해 일하는 녀석과 그런 녀석을 만드는 녀석.</p>\n</blockquote>\n<h2 id=\"entity-manager\" style=\"position:relative;\"><a href=\"#entity-manager\" aria-label=\"entity manager permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Entity Manager</h2>\n<p>엔티티(Enitty)를 영속성 컨텍스트에 저장(persist)하고, 조회(find)할 때 영속성 컨텍스트에 보관하고 관리하는 역할을 하는 녀석이다. 그리고 엔티티 매니저는 특정 시점까지 DB 커넥션을 얻지 않고, 스레드 간 공유 시 동시성 문제가 발생할 수 있다.</p>\n<h2 id=\"entity-manager-factory\" style=\"position:relative;\"><a href=\"#entity-manager-factory\" aria-label=\"entity manager factory permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Entity Manager Factory</h2>\n<p>엔티티 매니저 공장은 생성 비용이 크기 때문에 보통 하나의 DB를 사용할 경우 하나만 생성해서 사용한다. 대신 엔티티 매니저는 공장을 통해서 요청마다 엔티티 매니저가 만들어져 나오기 때문에 여러 개가 존재할 수 있다. 그리고 엔티티 매니저 공장은 스레드 간 공유해도 안전하다.\n<img src=\"https://user-images.githubusercontent.com/45007556/97259469-2b74cf00-185e-11eb-8172-6f78deb632df.png\" alt=\"image\"></p>\n<h1 id=\"엔티티entity의-생명-주기life-cycle\" style=\"position:relative;\"><a href=\"#%EC%97%94%ED%8B%B0%ED%8B%B0entity%EC%9D%98-%EC%83%9D%EB%AA%85-%EC%A3%BC%EA%B8%B0life-cycle\" aria-label=\"엔티티entity의 생명 주기life cycle permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>엔티티(Entity)의 생명 주기(Life Cycle)</h1>\n<p>영속성에 대해서 이해하기 위해서는 우선 엔티티의 생명주기를 알아야 한다.\n<img src=\"https://user-images.githubusercontent.com/45007556/97259485-3465a080-185e-11eb-8532-49a64c5de7a8.png\" alt=\"image\"></p>\n<h2 id=\"비영속newtransient\" style=\"position:relative;\"><a href=\"#%EB%B9%84%EC%98%81%EC%86%8Dnewtransient\" aria-label=\"비영속newtransient permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>비영속(new/transient)</h2>\n<p>엔티티를 생성만 하고, 아무것도 하지 않은 상태. 아직은 영속성 컨텍스트와 전혀 관계가 없다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">Member</span> member <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Member</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"영속managed\" style=\"position:relative;\"><a href=\"#%EC%98%81%EC%86%8Dmanaged\" aria-label=\"영속managed permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>영속(managed)</h2>\n<blockquote>\n<p>영속성 컨텍스트에 엔티티가 저장된 상태.</p>\n</blockquote>\n<p>이때부터 엔티티가 영속성 컨텍스트에 의해 관리된다. 영속화 한다고 바로 DB에 저장이 되는 것은 아니고, 트랜잭션 commit 시점에 영속성 컨텍스트에 있는 정보들이 이 때 SQL이 실행되어 DB에 저장이 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">em<span class=\"token punctuation\">.</span><span class=\"token function\">persist</span><span class=\"token punctuation\">(</span>member<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"준영속detached\" style=\"position:relative;\"><a href=\"#%EC%A4%80%EC%98%81%EC%86%8Ddetached\" aria-label=\"준영속detached permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>준영속(detached)</h2>\n<blockquote>\n<p>영속성 컨텍스트에 엔티티가 저장되었다가 분리된 상태.</p>\n</blockquote>\n<h3 id=\"준영속-상태를-만드는-방법\" style=\"position:relative;\"><a href=\"#%EC%A4%80%EC%98%81%EC%86%8D-%EC%83%81%ED%83%9C%EB%A5%BC-%EB%A7%8C%EB%93%9C%EB%8A%94-%EB%B0%A9%EB%B2%95\" aria-label=\"준영속 상태를 만드는 방법 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>준영속 상태를 만드는 방법</h3>\n<p>영속 상태인 엔티티를 준영속 상태로 바꾸는 방법은 영속성 컨텍스트에서 분리하거나, 엔티티 매니저를 초기화 및 종료하여 엔티티가 관리되지 않게 하는 방법이 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">//1. 해당 엔티티를 준영속 상태로 변경</span>\nem<span class=\"token punctuation\">.</span><span class=\"token function\">detach</span><span class=\"token punctuation\">(</span>member<span class=\"token punctuation\">)</span>\n<span class=\"token comment\">//2. 영속성 컨텍스트 초기화</span>\nem<span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">//3. 영속성 컨텍스트 종\u001f료</span>\nem<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h3 id=\"그럼-준영속-상태에서-영속-상태로-바꾸는-방법은\" style=\"position:relative;\"><a href=\"#%EA%B7%B8%EB%9F%BC-%EC%A4%80%EC%98%81%EC%86%8D-%EC%83%81%ED%83%9C%EC%97%90%EC%84%9C-%EC%98%81%EC%86%8D-%EC%83%81%ED%83%9C%EB%A1%9C-%EB%B0%94%EA%BE%B8%EB%8A%94-%EB%B0%A9%EB%B2%95%EC%9D%80\" aria-label=\"그럼 준영속 상태에서 영속 상태로 바꾸는 방법은 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>그럼 준영속 상태에서 영속 상태로 바꾸는 방법은?</h3>\n<p>병합(merge)을 사용하면 된다 merge메소드는 준영속 상태의 엔티티를 받아서 영속 상태의 엔티티를 반환하게 된다.\n병합은 해당 엔티티로 모든 값을 교체하기 때문에 엔티티의 값이 없으면 null을 업데이트할 위험이 있다. 준영속 전환이 아닌 엔티티 변경이 목적일 경우 병합 대신 변경 감지를 이용하는 것이 좋다.</p>\n<h4 id=\"전환-순서\" style=\"position:relative;\"><a href=\"#%EC%A0%84%ED%99%98-%EC%88%9C%EC%84%9C\" aria-label=\"전환 순서 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>전환 순서</h4>\n<ol>\n<li>파라미터로 넘어온 준영속 엔티티의 식별자 값으로 1차 캐시에서 엔티티를 조회</li>\n<li>만약 1차 캐시에 엔티티가 없으면 데이터베이스에서 엔티티를 조회하고 1차 캐시에 저장</li>\n<li>조회한 영속 엔티티에 파라미터로 넘어온 비영속 엔티티의 값을 채워 넣는다.</li>\n<li>새로운 영속 엔티티를 반환</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">em<span class=\"token punctuation\">.</span><span class=\"token function\">merge</span><span class=\"token punctuation\">(</span>member<span class=\"token punctuation\">)</span></code></pre></div>\n<h3 id=\"비영속과의-차이점\" style=\"position:relative;\"><a href=\"#%EB%B9%84%EC%98%81%EC%86%8D%EA%B3%BC%EC%9D%98-%EC%B0%A8%EC%9D%B4%EC%A0%90\" aria-label=\"비영속과의 차이점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>비영속과의 차이점?</h3>\n<p>엔티티 매니저를 통한 영속성 컨텍스트의 지원을 하나도 받지 못한다는 건 동일한데, 영속 상태가 되었었기 때문에 준영속 상태는 식별자 값이 존재한다는 차이가 있다.</p>\n<h2 id=\"삭제removed\" style=\"position:relative;\"><a href=\"#%EC%82%AD%EC%A0%9Cremoved\" aria-label=\"삭제removed permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>삭제(removed)</h2>\n<blockquote>\n<p>영속성 컨텍스트에서 엔티티가 삭제된 상태.</p>\n</blockquote>\n<p>엔티티가 삭제되면 DB에서도 삭제된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">em<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span>member<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h1 id=\"플러시flush\" style=\"position:relative;\"><a href=\"#%ED%94%8C%EB%9F%AC%EC%8B%9Cflush\" aria-label=\"플러시flush permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>플러시(flush)</h1>\n<blockquote>\n<p>영속성 컨텍스트의 변경 내용을 DB에 반영하는 것</p>\n</blockquote>\n<h2 id=\"플러시의-동작-순서\" style=\"position:relative;\"><a href=\"#%ED%94%8C%EB%9F%AC%EC%8B%9C%EC%9D%98-%EB%8F%99%EC%9E%91-%EC%88%9C%EC%84%9C\" aria-label=\"플러시의 동작 순서 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>플러시의 동작 순서</h2>\n<ol>\n<li><strong>변경 감지</strong> 동작 실행.</li>\n<li>SQL저장소의 SQL들을 DB에 전송(SELECT, UPDATE… 등 쿼리 실행).</li>\n</ol>\n<h2 id=\"변경-감지\" style=\"position:relative;\"><a href=\"#%EB%B3%80%EA%B2%BD-%EA%B0%90%EC%A7%80\" aria-label=\"변경 감지 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>변경 감지</h2>\n<p>JPA에서 Update를 하려고 하면 수정을 지원하는 메소드가 없다. 그 이유는 바로 변경 감지를 지원하기 때문인데, 엔티티를 스냅샷과 비교해서 바뀐 것이 있으면 수정 쿼리를 생성해서 SQL저장소에 등록한다. flush는 플러시할 때에만 동작한다.</p>\n<h3 id=\"jpa-update-전략\" style=\"position:relative;\"><a href=\"#jpa-update-%EC%A0%84%EB%9E%B5\" aria-label=\"jpa update 전략 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>JPA UPDATE 전략</h3>\n<p>필드가 몇개가 바뀌든 그냥 전체 필드를 업데이트 친다. 그렇기 때문에 쿼리가 항상 동일하고, 이전에 업데이트 친 경우가 있을 경우 이전 쿼리를 재사용 한다.</p>\n<h2 id=\"플러시-방법\" style=\"position:relative;\"><a href=\"#%ED%94%8C%EB%9F%AC%EC%8B%9C-%EB%B0%A9%EB%B2%95\" aria-label=\"플러시 방법 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>플러시 방법</h2>\n<p>총 3가지 방법이 있는데, 보통 트랜잭션을 커밋해서 플러시가 자동으로 호출되도록 하고, flush메소드를 직접 호출하는 경우는 테스트할 때를 제외하고는 거의 없다.</p>\n<ol>\n<li>em.flush() 직접 호출.</li>\n<li>트랜잭션 커밋 시 플러시가 자동 호출.</li>\n<li>JPQL쿼리 실행시 플러시가 자동 호출.</li>\n</ol>\n<h1 id=\"참고\" style=\"position:relative;\"><a href=\"#%EC%B0%B8%EA%B3%A0\" aria-label=\"참고 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>참고</h1>\n<p>자바 ORM 표준 JPA 프로그래밍 책</p>","frontmatter":{"title":"JPA 영속성(Persistence) 정리","date":"October 28, 2020"}}},"pageContext":{"slug":"/2020/2020-10-28-JPA-Persistence Context/","previous":{"fields":{"slug":"/2020/2020-10-15-custom-domain-registration/"},"frontmatter":{"title":"GoDaddy를 통한 도메인 구매 및 깃허브 페이지 연동하기","category":"Other","draft":false}},"next":{"fields":{"slug":"/2020/2020-10-31-Git-Commit-Message/"},"frontmatter":{"title":"Git 커밋 메세지를 수정하는 방법","category":"Other","draft":false}}}},"staticQueryHashes":["3128451518","521680639"]}